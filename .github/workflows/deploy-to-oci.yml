name: Deploy to Docker Hub

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

env:
  DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}/linkup-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # ğŸ”½ GitHub Packagesâ€§ì†ŒìŠ¤ ì½ê¸° ê¶Œí•œ ì„ ì–¸
    permissions:
      packages: read     # GitHub Packages(PKG) ë‹¤ìš´ë¡œë“œ
      contents: read     # ë¦¬í¬ì§€í† ë¦¬ checkout

    steps:
      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ)
      - name: Build with Gradle
        run: ./gradlew build -x test

      # Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub ì‚¬ìš©ì ì´ë¦„
          password: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub íŒ¨ìŠ¤ì›Œë“œ (ì•¡ì„¸ìŠ¤ í† í° ì‚¬ìš© ê¶Œì¥)

      # Docker Buildx ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_REPO }}:${{ github.sha }},${{ env.DOCKER_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ì„œë²„ì— SSHë¡œ ì ‘ì†í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}  # ì„œë²„ ì£¼ì†Œ
          username: ${{ secrets.SERVER_SSH_USERNAME }}  # SSH ì‚¬ìš©ìëª…
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}  # SSH ê°œì¸ í‚¤
          port: ${{ secrets.SERVER_SSH_PORT }}  # SSH í¬íŠ¸
          script: |
            sudo usermod -aG docker ${{ secrets.SERVER_SSH_USERNAME }}
            docker stop app-container || true
            echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì‹œë„ ì™„ë£Œ"

            docker rm app-container || true
            echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±° ì‹œë„ ì™„ë£Œ"          
            
            docker pull ${{ env.DOCKER_REPO }}:latest
            echo "Docker ì´ë¯¸ì§€ í’€ë§ ì™„ë£Œ"
            
            docker run -d \
              --name app-container \
              -p 8443:8443 \
              -e JWT_SECRET="${{secrets.JWT_SECRET}}" \
              -e SPRING_DATASOURCE_URL="${{secrets.MYSQL_URL}}" \
              -e SPRING_DATASOURCE_USERNAME="${{secrets.MYSQL_USER}}" \
              -e SPRING_DATASOURCE_PASSWORD="${{secrets.MYSQL_PASSWORD}}" \
              -e GOOGLE_CLIENT_ID="${{secrets.GOOGLE_CLIENT_ID}}" \
              -e GOOGLE_CLIENT_SECRET="${{secrets.GOOGLE_CLIENT_SECRET}}" \
              -e KAKAO_CLIENT_ID="${{secrets.KAKAO_CLIENT_ID}}" \
              -e KAKAO_CLIENT_SECRET="${{secrets.KAKAO_CLIENT_SECRET}}" \
              -e NAVER_CLIENT_ID="${{secrets.NAVER_CLIENT_ID}}" \
              -e NAVER_CLIENT_SECRET="${{secrets.NAVER_CLIENT_SECRET}}" \
              -e SPRING_PROFILES_ACTIVE="${{secrets.SPRING_PROFILES_ACTIVE}}" \
              -e GEMINI_API_KEY="${{secrets.GEMINI_API_KEY}}" \
              -e SERVER_PORT="${{secrets.PORT}}" \
              ${{ env.DOCKER_REPO }}:latest
            
            echo "ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œë„ ì™„ë£Œ"
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"